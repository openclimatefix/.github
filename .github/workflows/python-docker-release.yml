name: Bump version and auto-release
on:
  workflow_call:
    secrets:
      token:
        required: true
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true
    inputs:
      image_base_name:
        required: true
        type: string
      docker_file:
        required: false
        type: string
        default: Dockerfile

jobs:
  all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Bump version
        uses: openclimatefix/.github/.github/actions/bump-version@fix-bump-version-order
        id: bumper
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish python package
        uses: openclimatefix/.github/.github/actions/publish-python@fix-bump-version-order
        with:
          pypi_token: ${{ secrets.token }}

      - name: Github release
        uses: openclimatefix/.github/.github/actions/github-release@fix-bump-version-order
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ steps.bumper.outputs.new_ver }}

      - name: Docker relase
        uses: openclimatefix/.github/.github/actions/docker-release@fix-bump-version-order
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ steps.bumper.outputs.new_ver }}
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          docker_file: ${{ inputs.docker_file }}
          image_base_name: ${{ inputs.image_base_name }}
